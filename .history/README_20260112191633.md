# Weather Station Server

Backend Flask + Socket.IO dan dashboard web yang disajikan melalui Nginx reverse proxy.

## Arsitektur (Produksi)

- `nginx` (host `:9999`) melayani dashboard (`frontend/`) dan mem-proxy:
  - `/api/` ke `http://weather-station:1111`
  - `/socket.io/` (WebSocket upgrade) ke `http://weather-station:1111`
- `weather-station` (host `:1111`) menjalankan API dan Socket.IO.

Tidak ada IP yang di-hardcode di frontend maupun backend; seluruh akses menggunakan origin/proxy (relative path).

## Menjalankan (Docker Compose dari root repo)

1. Salin template environment:
```bash
cp .env.example .env
```

2. Jalankan:
```bash
docker compose up -d --build
```

3. Uji cepat:
```bash
curl http://localhost:1111/api/health
```

4. Verifikasi AI & Model (debugging):
- Dapatkan status AI melalui HTTP:
```bash
curl http://localhost:1111/api/ai/status | jq .
```
  Output contoh (fields penting): `data_count`, `distribution`, `trained`, `trained_at`, `model_path`, `model_exists`, `model_checksum`, `evaluation_mode`.
- Atau gunakan CLI debugging (lokal container):
```bash
python backend/app.py --ai-status
```
  Ini akan mencetak JSON singkat dengan `data_count`, `distribution`, `model_checksum` dan `evaluation_mode`.

5. Buka dashboard:
- `http://localhost:9999/#dashboard`

---

### Permission host folder (jika menggunakan Docker bind mounts)
✅ Karena direktori `./data` dan `./logs` di-mount ke `/var/lib/weather-station` dan `/var/log/weather-station`, pastikan host folder dimiliki oleh user yang sama seperti yang dijalankan di dalam container.

Langkah rekomendasi (tidak berasumsi UID):

1. Ambil UID/GID dari image/container `weather-station`:
```bash
# dapatkan UID
docker compose run --rm weather-station id -u
# dapatkan GID
docker compose run --rm weather-station id -g
```
2. Gunakan UID/GID tersebut untuk chown direktori host sebelum `docker compose up`:
```bash
sudo chown -R <UID>:<GID> ./data ./logs
```
3. Kemudian jalankan ulang container:
```bash
docker compose down
docker compose up -d --build
```

Jika Anda mengalami `Permission denied` saat menyimpan model (contoh: ke `/var/lib/weather-station/models`), periksa log container untuk pesan seperti:
- `AI model saved successfully to /var/lib/weather-station/models/weather_model.pkl` ✅
- `Failed to save AI model: Permission denied` ⚠️ (ikuti langkah chown di atas)

---

### Cara verifikasi model & evaluasi setelah training
- Jalankan training manual lewat UI atau API:
```bash
curl -X POST http://localhost:1111/api/train-model -H "Content-Type: application/json" -d '{}'
```
- Periksa log container (`./logs/app.log`) dan cari baris:
  - `AI: Metrics train_acc=... test_acc=... macro_f1=... bal_acc=... mode=VALID` (atau mode=NON_VALID jika evaluasi tidak representatif)
  - `AI model saved successfully to /var/lib/weather-station/models/weather_model.pkl`

- Periksa `/api/ai/status` untuk `evaluation_mode` dan `last_metrics` yang menjelaskan validitas evaluasi.

## Struktur Folder (final)

```
weather-station-server/
  backend/
    app.py
  config/
    server.conf
    server.conf.example
  data/
    backups/               # lokasi backup (persist)
    models/                # lokasi model runtime (persist)
    device_configs/        # konfigurasi device (persist)
    client_settings.json   # pengaturan dashboard (persist)
  docker/
    Dockerfile
    nginx.conf
    docker-compose.example.yml
  frontend/
    index.html
    styles.css
  logs/
  ssl/
  .env                    # tidak di-commit (lihat .gitignore)
  .env.example
  .gitignore
  docker-compose.yml      # satu-satunya sumber kebenaran
  requirements.txt
```

## Konfigurasi

### `config/server.conf` (format KEY=VALUE)

`server.conf` wajib format dotenv-like:
```ini
HOST=0.0.0.0
PORT=1111
DEBUG=false
LOG_LEVEL=INFO
```

Urutan prioritas konfigurasi:
1) `config/server.conf` (dev/local) dan `/etc/weather-station/server.conf` (runtime container)
2) Environment dari `.env` (ENV selalu menang)

Catatan: backend tidak pernah menulis ulang `server.conf`. Jika diperlukan penyimpanan runtime, backend akan menulis ke:
- `data/runtime_config.json` (opsional, untuk snapshot)

### `.env` / `.env.example`

- `.env` digunakan oleh `docker-compose.yml` dan tidak boleh di-commit.
- `DEVICE_SHARED_SECRET` (opsional): aktifkan verifikasi signature untuk endpoint device (lihat bagian ESP32).

## Fondasi Integrasi ESP32 via Web (API Kontrak)

Semua konfigurasi device disimpan per perangkat di `data/device_configs/<device_id>.json`.

### 1) Simpan konfigurasi yang diinginkan (pending)
`POST /api/devices/<device_id>/config`

Contoh:
```bash
curl -X POST http://localhost:1111/api/devices/esp32-1/config \
  -H "Content-Type: application/json" \
  -d '{"sensor_interval":5,"selected_sensors":{"temperature":true}}'
```

### 2) Device polling perintah
`GET /api/devices/<device_id>/commands`

Contoh:
```bash
curl http://localhost:1111/api/devices/esp32-1/commands
```

Jika ada konfigurasi pending, server akan mengirim:
- `command: "apply_config"`
- `command_id`
- `payload` (konfigurasi)

### 3) ACK hasil penerapan
`POST /api/devices/<device_id>/ack`

Contoh:
```bash
curl -X POST http://localhost:1111/api/devices/esp32-1/ack \
  -H "Content-Type: application/json" \
  -d '{"command_id":"<isi-dari-commands>","success":true,"reason":""}'
```

### Signature (opsional) untuk device

Jika `DEVICE_SHARED_SECRET` diisi, request device wajib mengirim header:
- `X-Device-Signature: <hex>`

Format HMAC (SHA-256) yang ditandatangani:
`{METHOD} {PATH}\n{device_id}\n{raw_body}`

Jika tidak diisi, verifikasi signature dilewati.
